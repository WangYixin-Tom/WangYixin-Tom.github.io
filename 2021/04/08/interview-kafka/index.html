<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="kafka必知必会, python rabbitmq redis flask kafka">
    <meta name="baidu-site-verification" content="code-KoKq36g1n2">
    <meta name="google-site-verification" content="yCy2azpds5XSuGZvis6OuA-XIGF5GuGpYRAaGfD6o48">
    <meta name="360-site-verification" content="b7c11a830ef90fd1464ad6206bb7b6e7">
    <meta name="description" content="概述Kafka 是什么？主要应用场景有哪些？Kafka 是一个分布式流式处理平台，可以作为企业级的消息引擎。
Kafka 主要有两大应用场景：

消息队列 ：建立实时流数据管道，以可靠地在系统或应用程序之间获取数据。
数据处理： 构建实时的">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>kafka必知必会 | 好好学习</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    
        <script>
            (function(){
                var bp = document.createElement('script');
                var curProtocol = window.location.protocol.split(':')[0];
                if (curProtocol === 'https') {
                    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
                }
                else {
                    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
                }
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(bp, s);
            })();
        </script>
    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">好好学习</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">好好学习</div>
        <div class="logo-desc">
            
            业精于勤荒于嬉，行成于思毁于随
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        kafka必知必会
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/interview/" target="_blank">
                            <span class="chip bg-color">interview</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/interview/" class="post-category" target="_blank">
                            interview
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-04-08
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    wangyixin-tom
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    6.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    21 分
                </div>
                
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="Kafka-是什么？主要应用场景有哪些？"><a href="#Kafka-是什么？主要应用场景有哪些？" class="headerlink" title="Kafka 是什么？主要应用场景有哪些？"></a>Kafka 是什么？主要应用场景有哪些？</h3><p>Kafka 是一个分布式流式处理平台，可以作为企业级的消息引擎。</p>
<p>Kafka 主要有两大应用场景：</p>
<ol>
<li><strong>消息队列</strong> ：建立实时流数据管道，以可靠地在系统或应用程序之间获取数据。</li>
<li><strong>数据处理：</strong> 构建实时的流数据处理程序来转换或处理数据流。</li>
</ol>
<h3 id="Kafka的优势在哪里？"><a href="#Kafka的优势在哪里？" class="headerlink" title="Kafka的优势在哪里？"></a>Kafka的优势在哪里？</h3><ol>
<li><strong>极致的性能</strong> ：最高可以每秒处理千万级别的消息。</li>
<li><strong>生态系统兼容性无可匹敌</strong> ：尤其在大数据和流计算领域。</li>
</ol>
<h3 id="Kafka和rabbitmq比较"><a href="#Kafka和rabbitmq比较" class="headerlink" title="Kafka和rabbitmq比较"></a>Kafka和rabbitmq比较</h3><p><strong>rabbitmq</strong></p>
<ul>
<li>Erlang 语言编写的，轻量级、迅捷。</li>
<li>Exchange 模块支持非常灵活的路由配置。</li>
<li>队列模型：生产者将消息发送到交换器，通过匹配交换器类型、Binding Key、Routing Key后，路由到一个或者多个队列中。队列用于存储消息，消费者直接绑定队列以消费消息。</li>
</ul>
<p><strong>问题：</strong></p>
<ul>
<li>RabbitMQ 对消息堆积的支持并不好，当大量消息积压的时候，会导致 RabbitMQ 的性能急剧下降。</li>
<li>性能一般，大概每秒钟可以处理几万到十几万条消息</li>
</ul>
<p><strong>kafka</strong></p>
<ul>
<li>使用 Scala 和 Java 语言开发。</li>
<li>性能比较好，大约每秒钟可以处理几十万条消息，极限处理能力可以超过每秒 2000 万条消息。</li>
<li>发布订阅模型：生产者直接发消息到主题，每个主题可以包含多个分区。消息消费支持消费者组，多个分区会平均分配给同一个消费者组里的不同消费者。不在同一个消费者组的消费者能订阅消费同一条消息，相同消费者组的消费者存在消费竞争（负载均衡）</li>
<li>Kafka具有消息存储的功能，消息被消费后不会被立即删除，需要被不同的消费者组消费</li>
</ul>
<p><strong>问题：</strong></p>
<p>同步收发消息的响应时延比较高，因为当客户端发送一条消息的时候，Kafka 并不会立即发送出去，而是要等一会儿攒一批再发送，每秒钟消息数量没有那么多的时候，Kafka 的时延反而会比较高。所以，Kafka 不太适合在线业务场景。</p>
<table>
<thead>
<tr>
<th><strong>对比项</strong></th>
<th align="center"><strong>RabbitMQ</strong></th>
<th align="center"><strong>Kafka</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>吞吐量</strong></td>
<td align="center"><strong>低</strong></td>
<td align="center"><strong>高</strong></td>
</tr>
<tr>
<td><strong>有序性</strong></td>
<td align="center"><strong>全局有序性</strong></td>
<td align="center"><strong>分区有序性</strong></td>
</tr>
<tr>
<td>消息可靠性</td>
<td align="center">多策略组合</td>
<td align="center">消息持久化</td>
</tr>
<tr>
<td><strong>消费者模式</strong></td>
<td align="center">推拉</td>
<td align="center">拉</td>
</tr>
<tr>
<td><strong>消息堆积</strong></td>
<td align="center">无法支持较大的消息堆积</td>
<td align="center">支持消息堆积，并批量持久化到磁盘</td>
</tr>
<tr>
<td><strong>流处理</strong></td>
<td align="center">不支持</td>
<td align="center">支持</td>
</tr>
<tr>
<td><strong>时效性</strong></td>
<td align="center"><strong>高</strong></td>
<td align="center"><strong>中</strong></td>
</tr>
<tr>
<td>运维便捷度</td>
<td align="center">高</td>
<td align="center">中</td>
</tr>
<tr>
<td><strong>系统依赖</strong></td>
<td align="center"><strong>无</strong></td>
<td align="center"><strong>zookeeper</strong></td>
</tr>
<tr>
<td>Web监控</td>
<td align="center">自带</td>
<td align="center">第三方</td>
</tr>
<tr>
<td><strong>优先级队列</strong></td>
<td align="center">支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td><strong>死信</strong></td>
<td align="center">支持</td>
<td align="center">不支持</td>
</tr>
<tr>
<td><strong>消息回溯</strong></td>
<td align="center"><strong>支持</strong></td>
<td align="center"><strong>不支持</strong></td>
</tr>
</tbody></table>
<h2 id="Producer、Consumer、Broker、Topic、Partition、Record？"><a href="#Producer、Consumer、Broker、Topic、Partition、Record？" class="headerlink" title="Producer、Consumer、Broker、Topic、Partition、Record？"></a>Producer、Consumer、Broker、Topic、Partition、Record？</h2><ol>
<li><strong>Producer（生产者）</strong> ： 产生消息的一方。</li>
<li><strong>Consumer（消费者）</strong>：消费消息的一方。</li>
<li><strong>Broker（代理）</strong> :  Kafka 实例。</li>
</ol>
<ul>
<li><strong>Topic（主题）</strong> : 通过不同的主题区分不同的业务类型的消息记录。生产者将消息发送到特定的主题，消费者通过订阅特定的主题来消费消息。</li>
<li><strong>Partition（分区）</strong>： 分区属于主题的一部分。一个主题可以有多个分区 ，同一主题下的分区可以分布在不同的Broker上。</li>
<li><strong>记录（Record）：</strong>写入到kafka并可以被消费者读取的数据。每条记录包含一个键、值和时间戳。</li>
</ul>
<h2 id="LEO、LSO、AR、ISR、HW？"><a href="#LEO、LSO、AR、ISR、HW？" class="headerlink" title="LEO、LSO、AR、ISR、HW？"></a>LEO、LSO、AR、ISR、HW？</h2><ul>
<li>LEO（Log End Offset）：日志末端位移值或末端偏移量，表示日志下一条待插入消息的位移值。</li>
<li>LSO（Log Stable Offset）：该值控制了事务型消费者能够看到的消息范围。</li>
<li>AR（Assigned Replicas）：主题被创建后，创建的副本集合，副本个数由副本因子决定。</li>
<li>ISR（In-Sync Replicas）：AR中与领导者副本保持同步的副本集合。领导者副本天然在ISR中。</li>
<li>HW（High watermark）：高水位值，这是控制消费者可读取消息范围。一个普通消费者只能看到Leader上介于Log Start Offset和高水位（不含）之间的所有消息。</li>
</ul>
<h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><h3 id="ack-机制"><a href="#ack-机制" class="headerlink" title="ack 机制"></a>ack 机制</h3><ul>
<li>0：生产者不会等待 broker 的 ack，延迟最低，可能丢数据</li>
<li>1：服务端会等待领导者副本收到消息，成功写入PageCache后，会返回ack，此时领导者副本切换可能丢数据</li>
<li>-1：领导者副本所在broker收到消息后，等待所有ISR列表中的追随者副本返回结果后，再返回ack，数据不会丢失。</li>
</ul>
<p>数据从领导者副本同步到追随者副本，需要2步：</p>
<ul>
<li>数据从pageCache被刷盘到磁盘。因为只有磁盘中的数据才能被同步到副本。</li>
<li>数据同步到追随者副本中，并且replica成功将数据写入PageCache。在生产者得到ack后，哪怕是所有机器都停电，数据也至少会存在于领导者副本的磁盘内。</li>
</ul>
<h3 id="生产端怎么实现幂等的"><a href="#生产端怎么实现幂等的" class="headerlink" title="生产端怎么实现幂等的"></a>生产端怎么实现幂等的</h3><p><strong>幂等性生产者</strong></p>
<p>设置<code>props.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG， true)</code></p>
<p><strong>底层原理：</strong>空间去换时间，即在 Broker 端多保存一些字段。当生产者发送了具有相同字段值的消息后，Broker 能够自动知晓这些消息已经重复了，于是把它们“丢弃”掉。</p>
<ul>
<li>ProducerID：生产者ID，在每个新的Producer初始化时，会被分配一个唯一的ProducerID，这个ProducerID对客户端使用者是不可见的。</li>
<li>SequenceNumber：消息序列号，对于每个ProducerID，生产者发送数据的每个主题和分区都对应一个从0开始单调递增的SequenceNumber值。</li>
</ul>
<p><strong>作用范围：</strong>它只能保证单分区上的幂等性，能够保证某个主题的一个分区上不出现重复消息。只能实现单会话上的幂等性，不能实现跨会话的幂等性。</p>
<h3 id="怎么确定向哪一个分区写消息"><a href="#怎么确定向哪一个分区写消息" class="headerlink" title="怎么确定向哪一个分区写消息"></a>怎么确定向哪一个分区写消息</h3><p>获取集群的分区数据之后，根据生产者分区策略，只要如果分区规则设置的合理，那么所有的消息将会被均匀的分布到不同的分区中，这样就实现了负载均衡和水平扩展。具体策略包括：</p>
<p><strong>轮询策略</strong></p>
<p><code>Round-robin</code> 策略，即顺序分配。</p>
<p>轮询策略有非常优秀的负载均衡表现，它总是能保证消息最大限度地被平均分配到所有分区上，最合理也最常用的分区策略。</p>
<p><strong>随机策略</strong></p>
<p><code>Randomness</code>策略。将消息放置到任意一个分区上。</p>
<p><strong>按消息键保序策略</strong></p>
<p>Kafka 允许为每条消息定义消息键，简称为 Key。可以保证同一个 Key 的所有消息都进入到相同的分区里面，每个分区下的消息处理都是有顺序的。</p>
<h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><h3 id="什么是消费者组？"><a href="#什么是消费者组？" class="headerlink" title="什么是消费者组？"></a>什么是消费者组？</h3><p>可扩展且具有容错性的消费者机制。</p>
<ul>
<li>Kafka允许你将同一份消息广播到多个消费者组里。</li>
<li>一个消费者组中可以包含多个消费者，他们共同消费该主题的数据。</li>
<li>同一个消费者组下的消费者有相同的组ID，他们被分配不同的订阅分区。</li>
<li>当某个消费者挂掉的时候，其他消费者会自动地承担起它负责消费的分区。 </li>
</ul>
<h3 id="如何保证消息的消费顺序？"><a href="#如何保证消息的消费顺序？" class="headerlink" title="如何保证消息的消费顺序？"></a>如何保证消息的消费顺序？</h3><p>Kafka 只能为我们保证分区中的消息有序，而不能保证主题中的消息有序。</p>
<ol>
<li>一个主题只对应一个 分区。</li>
<li>（推荐）发送消息的时候指定key/分区。</li>
</ol>
<h3 id="consumer-offsets-作用？"><a href="#consumer-offsets-作用？" class="headerlink" title="__consumer_offsets 作用？"></a>__consumer_offsets 作用？</h3><ul>
<li>位移主题，存储消费者的位移数据，位移主题消息的 Key 中格式：&lt;Group ID，主题名，分区号 &gt;，消息体保存了<strong>位移值</strong>和位移提交的元数据，诸如时间戳和用户自定义的数据等。</li>
<li>保存消费者组相关的消息</li>
<li>用于删除消费者组过期位移、删除消费者组的消息。tombstone 消息，即墓碑消息</li>
</ul>
<h3 id="消费者如何获取到offset"><a href="#消费者如何获取到offset" class="headerlink" title="消费者如何获取到offset"></a>消费者如何获取到offset</h3><ol>
<li><p>确定由位移主题的哪个分区来保存该 Group 数据：<code>partitionId=Math.abs(groupId.hashCode() % offsetsTopicPartitionCount)</code>。</p>
</li>
<li><p>找出该分区 Leader 所在的 Broker，该 Broker 即为对应的 Coordinator。</p>
</li>
<li><p>重平衡后，协调者统一以 SyncGroup 响应的方式分发给所有成员，这样组内所有成员就都知道自己该消费哪些分区了。</p>
</li>
<li><p>位移主题消息的 Key 中格式：&lt;Group ID，主题名，分区号 &gt;，消息体保存了<strong>位移值</strong>和位移提交的元数据，诸如时间戳和用户自定义的数据等</p>
</li>
</ol>
<h3 id="Java-Consumer为什么采用单线程来获取消息？"><a href="#Java-Consumer为什么采用单线程来获取消息？" class="headerlink" title="Java Consumer为什么采用单线程来获取消息？"></a>Java Consumer为什么采用单线程来获取消息？</h3><p>Java Consumer是双线程的设计。用户主线程，负责获取消息；心跳线程，负责向Kafka汇报消费者存活情况。将心跳单独放入专属的线程，能够有效地规避因消息处理速度慢而被视为下线的假死情况。</p>
<ul>
<li>单线程获取消息的设计能够避免阻塞式的消息获取方式。单线程轮询方式容易实现<strong>异步非阻塞式</strong>，这样便于将消费者扩展成支持实时流处理的操作算子。因为很多实时流处理操作算子都不能是阻塞式的。</li>
<li>可以简化代码的开发。多线程交互的代码是非常容易出错的。</li>
</ul>
<h3 id="消息是采用-Pull-模式，还是-Push-模式？"><a href="#消息是采用-Pull-模式，还是-Push-模式？" class="headerlink" title="消息是采用 Pull 模式，还是 Push 模式？"></a>消息是采用 Pull 模式，还是 Push 模式？</h3><p>生产者将消息推送到 broker，消费者从 broker 拉取消息。</p>
<h3 id="消费者如何消费数据"><a href="#消费者如何消费数据" class="headerlink" title="消费者如何消费数据"></a>消费者如何消费数据</h3><blockquote>
<p>KafkaConsumer 类不是线程安全的 （thread-safe），不能在多个线程中共享同一个 KafkaConsumer 实例，否则程序会抛出 <code>ConcurrentModificationException</code>异常</p>
</blockquote>
<p>1.消费者程序启动多个线程，每个线程维护专属的 KafkaConsumer 实例，负责完整的消息获取、消息处理流程</p>
<p>2.消费者程序使用单或多线程获取消息，同时创建多个消费线程执行消息处理逻辑。</p>
<h2 id="broker"><a href="#broker" class="headerlink" title="broker"></a>broker</h2><h3 id="消息位移的作用"><a href="#消息位移的作用" class="headerlink" title="消息位移的作用"></a>消息位移的作用</h3><p>用于标识消息在分区中的位置。</p>
<p>一旦消息被写入到分区日志，它的位移值将不能被修改。</p>
<h3 id="怎么实现消息持久化"><a href="#怎么实现消息持久化" class="headerlink" title="怎么实现消息持久化"></a>怎么实现消息持久化</h3><p>Kakfa 依赖文件系统来存储和缓存消息。Kafka 直接将数据写到了文件系统的日志中。</p>
<p>物理上把主题分成一个或多个分区，每个分区在物理上对应一个文件夹，该文件夹下存储这个分区的所有<strong>消息和索引文件</strong>。</p>
<h3 id="数据索引如何实现"><a href="#数据索引如何实现" class="headerlink" title="数据索引如何实现"></a>数据索引如何实现</h3><ul>
<li>将数据文件分段存储。每一个段单独放在一个.log的文件中，数据文件命名是20个字符的长度，以每一个分段文件开始的最下offset来命名，其他位置用0填充。</li>
<li>每个log文件的大小默认是1GB，每个log文件就会对应一个同名的index文件。</li>
<li>index文件采用了稀疏存储的方式，每隔一定字节的数据建立一条索引，避免了索引文件占用过多的空间和资源，从而可以将索引文件保留到内存中。没有建立索引的数据在查询的过程中需要小范围内的顺序扫描。</li>
</ul>
<h3 id="磁盘容量规划考虑因素？"><a href="#磁盘容量规划考虑因素？" class="headerlink" title="磁盘容量规划考虑因素？"></a>磁盘容量规划考虑因素？</h3><ul>
<li>新增消息数</li>
<li>消息留存时间</li>
<li>平均消息大小</li>
<li>备份数</li>
<li>是否启用压缩</li>
</ul>
<h3 id="多副本机制？好处？"><a href="#多副本机制？好处？" class="headerlink" title="多副本机制？好处？"></a>多副本机制？好处？</h3><ul>
<li>Kafka副本当前分为领导者副本和追随者副本。每个分区在创建时都要选举一个副本，作为领导者副本，其余的副本自动为追随者副本。</li>
<li>只有领导者副本才能对外提供读写服务。追随者副本只是采用拉的方式，同步领导者副本中的数据</li>
<li>在领导者副本所在的Broker宕机后，Kafka 依托于 ZooKeeper ，实时感知到，并开启领导者选举，从追随者副本中选一个作为新的领导者。</li>
</ul>
<p><strong>多分区多副本好处？</strong></p>
<ol>
<li>指定多分区， 而各个分区可以分布在不同的 Broker 上， 这样便能提供比较好的并发能力（负载均衡）。</li>
<li>多副本提高了消息存储的安全性，提高了容灾能力，不过也相应的增加了所需要的存储空间。</li>
<li>读写走领导者副本：方便实现Read-your-writes</li>
<li>读写走领导者副本：方便实现单调读，在多次消费消息时，它不会看到某条消息一会儿存在一会儿不存在</li>
</ol>
<h3 id="Zookeeper的作用"><a href="#Zookeeper的作用" class="headerlink" title="Zookeeper的作用"></a>Zookeeper的作用</h3><ul>
<li>存放元数据：主题分区的相关数据都保存在 ZooKeeper 中。</li>
<li>成员管理：Broker节点的注册、注销以及属性变更。</li>
<li>Controller 选举：选举集群 Controller节点</li>
<li>其他管理类任务：包括但不限于主题删除、参数配置等。</li>
</ul>
<h3 id="为什么不支持读写分离"><a href="#为什么不支持读写分离" class="headerlink" title="为什么不支持读写分离"></a>为什么不支持读写分离</h3><p>CAP理论下，我们只能保证可用性和一致性取其一。</p>
<p>如果支持读写分离，一致性就会有一定折扣，意味着可能的数据不一致，或数据滞后。</p>
<h3 id="Controller发生网络分区时，Kafka会怎么样？"><a href="#Controller发生网络分区时，Kafka会怎么样？" class="headerlink" title="Controller发生网络分区时，Kafka会怎么样？"></a>Controller发生网络分区时，Kafka会怎么样？</h3><p>判断：Broker端的ActiveControllerCount。</p>
<p>由于Controller会给Broker发送3类请求，LeaderAndIsrRequest，StopReplicaRequest，UpdateMetadataRequest，因此，一旦出现网络分区，这些请求将不能顺利到达Broker端。</p>
<p>将影响主题的创建、修改、删除操作的信息同步。</p>
<h3 id="追随者副本消息同步的流程？"><a href="#追随者副本消息同步的流程？" class="headerlink" title="追随者副本消息同步的流程？"></a>追随者副本消息同步的流程？</h3><ul>
<li>追随者副本发送FETCH请求给领导者副本。</li>
<li>领导者副本会读取底层日志文件中的消息数据，使用FETCH请求中的fetchOffset，更新追随者副本远程副本的LEO值。领导者副本副本尝试更新分区高水位值。</li>
<li>追随者副本接收到FETCH响应之后，会把消息写入到底层日志，接着更新LEO和追随者副本高水位值。</li>
</ul>
<p>领导者副本和追随者副本的高水位值更新时机是不同的，追随者副本的高水位更新永远落后于领导者副本的高水位。这种时间上的错配是造成各种不一致的原因。</p>
<h3 id="怎么保证同步成功？"><a href="#怎么保证同步成功？" class="headerlink" title="怎么保证同步成功？"></a>怎么保证同步成功？</h3><p>leader Epoch 由两部分数据组成。</p>
<ul>
<li>Epoch。一个单调增加的版本号。每当副本领导权发生变更时，都会增加该版本号。小版本号的 Leader 被认为是过期 Leader，不能再行使 Leader 权力。</li>
<li>起始位移（Start Offset）。领导者副本在该 Epoch 值上写入的首条消息的位移。</li>
</ul>
<p>Kafka Broker 会在内存中为每个分区都缓存 Leader Epoch 数据，同时它还会定期地将这些信息持久化到一个 checkpoint 文件中。 领导者副本写入消息到磁盘时，Broker 会尝试更新这部分缓存。如果该领导者副本是首次写入消息，那么 Broker 会向缓存中增加一个 Leader Epoch 条目。</p>
<h3 id="Leader总是-1，怎么破？"><a href="#Leader总是-1，怎么破？" class="headerlink" title="Leader总是-1，怎么破？"></a>Leader总是-1，怎么破？</h3><p>表明Controller不工作了，导致无法分配leader。</p>
<p><strong>方法</strong></p>
<p>1、删除ZooKeeper中的/controller节点，触发Controller重选举。Controller重选举能够为所有主题分区重刷分区状态，可以有效解决因不一致导致的领导者副本不可用问题。</p>
<p>2、重启Controller节点上的Kafka进程，让其他节点重新注册Controller角色。</p>
<h3 id="如何设置Kafka能接收的最大消息的大小？"><a href="#如何设置Kafka能接收的最大消息的大小？" class="headerlink" title="如何设置Kafka能接收的最大消息的大小？"></a>如何设置Kafka能接收的最大消息的大小？</h3><ul>
<li>Broker端参数：<code>message.max.bytes</code>，<code>max.message.bytes</code>（主题级别），<code>replica.fetch.max.bytes</code></li>
<li>消费者端参数：<code>fetch.message.max.bytes</code></li>
</ul>
<h3 id="Kafka如何保证高可用"><a href="#Kafka如何保证高可用" class="headerlink" title="Kafka如何保证高可用"></a>Kafka如何保证高可用</h3><p>Kafka 的副本机制：</p>
<ul>
<li>Kafka 集群由多个 Broker组成。一个Broker可以容纳多个主题，也就是一台服务器可以传输多个 主题 数据。Kafka 为了实现可扩展性，将一个 主题 分散到多个 分区 中。</li>
<li>Kafka 中同一个分区下的不同副本，分为 领导者副本和 追随者副本。领导者副本 负责处理所有 读写的请求，追随者副本 作为数据备份，拉取 领导者副本的数据进行同步。</li>
<li>如果某个 Broker 挂掉，Kafka 会从 ISR 列表中选择一个分区作为新的 领导者副本。</li>
</ul>
<h3 id="Kafka能手动删除消息吗？"><a href="#Kafka能手动删除消息吗？" class="headerlink" title="Kafka能手动删除消息吗？"></a>Kafka能手动删除消息吗？</h3><p>一般不需要用户手动删除消息。它本身提供了留存策略，能够自动删除过期消息。同时支持手动删除消息的。</p>
<ul>
<li>对于设置了Key且参数cleanup.policy=compact的主题而言，我们可以构造一条消息发送给Broker，依靠日志清理组件提供的功能删除掉该 Key 的消息。</li>
<li>对于普通主题，可以使用<code>kafka-delete-records</code>，或编写程序调用<code>Admin.deleteRecords</code>方法来删除消息。</li>
</ul>
<h3 id="如何确定合适的Kafka主题的分区数量？"><a href="#如何确定合适的Kafka主题的分区数量？" class="headerlink" title="如何确定合适的Kafka主题的分区数量？"></a>如何确定合适的Kafka主题的分区数量？</h3><p>需要根据每个分区的生产者和消费者的期望吞吐量进行估计，以便达到并行读写、负载均衡和高吞吐。</p>
<p>假设对于单个分区，生产者端的可达吞吐量为p，消费者端的可达吞吐量为c，期望的目标吞吐量为t，那么集群所需要的分区数量至少为<code>max(t/p,t/c)</code>。</p>
<p>在生产者端，单个分区的吞吐量大小会受到批量大小、数据压缩方法、 确认类型（同步/异步）、复制因子等配置参数的影响。</p>
<blockquote>
<p>假设期望读取数据的速率1GB/Sec，而一个消费者的读取速率为50MB/Sec，此时至少需要20个分区以及20个消费者。</p>
<p>如果期望生产数据的速率为<strong>1GB/Sec</strong>，而每个生产者的生产速率为<strong>100MB/Sec</strong>，此时就需要有10个分区。</p>
<p>设置20个分区，既可以保障生产速率，也可以保障的吞吐量</p>
</blockquote>
<h3 id="判断一个节点还活着的两个条件？"><a href="#判断一个节点还活着的两个条件？" class="headerlink" title="判断一个节点还活着的两个条件？"></a>判断一个节点还活着的两个条件？</h3><p>（1）节点必须可以维护和 ZooKeeper 的连接，Zookeeper 通过心跳机制检查每个节点的连接</p>
<p>（2）如果节点是追随者副本，他必须能及时的同步 leader 的写操作，延时不能太久</p>
<h3 id="存储在硬盘上的消息格式是什么？"><a href="#存储在硬盘上的消息格式是什么？" class="headerlink" title="存储在硬盘上的消息格式是什么？"></a>存储在硬盘上的消息格式是什么？</h3><p>消息由一个固定长度的头部和可变长度的字节数组组成。</p>
<ul>
<li>消息长度: 4 bytes</li>
<li>版本号: 1 byte</li>
<li>CRC 校验码: 4 bytes</li>
<li>具体的消息: n bytes</li>
</ul>
<h2 id="实际问题"><a href="#实际问题" class="headerlink" title="实际问题"></a>实际问题</h2><h3 id="如何保证消息不丢失"><a href="#如何保证消息不丢失" class="headerlink" title="如何保证消息不丢失"></a>如何保证消息不丢失</h3><h4 id="生产者丢失消息"><a href="#生产者丢失消息" class="headerlink" title="生产者丢失消息"></a>生产者丢失消息</h4><ul>
<li><p>生产者调用<code>send</code>方法发送消息之后，消息可能因为网络问题并没有发送过去。 为了确定消息是发送成功，我们要判断消息发送的结果。可以采用回调函数的形式，如果消息发送失败的话，我们检查失败的原因之后重新发送即可。</p>
</li>
<li><p>为 生产者的<code>retries</code>（重试次数）设置一个比较合理的值，一般是3。</p>
</li>
<li><p><strong>设置 acks = all</strong>，则表明所有副本 Broker 都要接收到消息，该消息才算是已提交</p>
</li>
</ul>
<h4 id="消费者丢失消息"><a href="#消费者丢失消息" class="headerlink" title="消费者丢失消息"></a>消费者丢失消息</h4><ul>
<li>关闭自动提交位移，每次在真正消费完消息之后之后，手动提交 。</li>
</ul>
<h4 id="Kafka-弄丢消息"><a href="#Kafka-弄丢消息" class="headerlink" title="Kafka 弄丢消息"></a>Kafka 弄丢消息</h4><ul>
<li>设置 <code>replication.factor &gt;= 3</code>。防止消息丢失的主要机制就是冗余。</li>
<li>设置 <code>min.insync.replicas &gt; 1</code>。消息至少要被写入到多少个副本才算是“已提交”。设置成大于 1 可以提升消息持久性。</li>
<li>设置 <code>unclean.leader.election.enable = false</code>。如果一个 Broker 落后原领导者副本太多，那么它一旦成为新的领导者副本，必然会造成消息的丢失。</li>
</ul>
<h3 id="如何保证消息不重复消费"><a href="#如何保证消息不重复消费" class="headerlink" title="如何保证消息不重复消费"></a>如何保证消息不重复消费</h3><p>去重：将消息的唯一标识保存到外部介质中，每次消费处理时判断是否处理过。</p>
<ol>
<li>利用数据库的唯一约束实现幂等</li>
<li>为更新的数据设置前置条件，比如版本号</li>
<li>GUID：在发送消息时，给每条消息指定一个全局唯一的 ID，消费时，先根据这个 ID 检查这条消息是否有被消费过，如果没有消费过，才更新数据，然后将消费状态置为已消费。</li>
</ol>
<h3 id="怎么增加消费的能力？"><a href="#怎么增加消费的能力？" class="headerlink" title="怎么增加消费的能力？"></a>怎么增加消费的能力？</h3><p>1、broker 端参数 <code>num.replica.fetchers</code>表示的是 追随者副本用多少个线程来拉取消息，默认使用 1 个线程。如果你的 Broker 端 CPU 资源很充足，适当调大该参数值，加快追随者副本的同步速度。</p>
<p>2、在 生产者端，如果要改善吞吐量，通常的标配是增加消息批次的大小以及批次缓存时间，即 <code>batch.size</code> 和 <code>linger.ms</code>。</p>
<p>3、压缩算法可减少网络 I/O 传输量，从而间接提升吞吐量。适配最好的两个压缩算法是 LZ4 和 zstd</p>
<p>4、消费者端使用多线程方案</p>
<h3 id="为什么性能好"><a href="#为什么性能好" class="headerlink" title="为什么性能好"></a>为什么性能好</h3><h4 id="顺序写"><a href="#顺序写" class="headerlink" title="顺序写"></a>顺序写</h4><blockquote>
<p>操作系统读写磁盘时，需要先寻址，再进行数据读写。如果是机械硬盘，寻址就需要较长的时间。</p>
</blockquote>
<p> Kafka 用的是顺序写，追加数据是追加到末尾，磁盘顺序写（pagecache）的性能极高。</p>
<h4 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h4><p>Kafka使用了零拷贝技术，使用<code>mmap+write</code>持久化数据，发送数据使用系统调用<code>sendfile</code>。</p>
<blockquote>
<p>传统的IO<code>read+write</code>方式会产生2次DMA拷贝+2次CPU拷贝，同时有4次上下文切换。</p>
<p>而通过<code>mmap+write</code>方式则产生2次DMA拷贝+1次CPU拷贝，4次上下文切换，通过内存映射减少了一次CPU拷贝，可以减少内存使用，适合大文件的传输。</p>
<p><code>sendfile</code>方式是新增的一个系统调用函数，产生2次DMA拷贝+1次CPU拷贝，但是只有2次上下文切换。因为只有一次调用，减少了上下文的切换，但是用户空间对IO数据不可见，适用于静态文件服务器。</p>
</blockquote>
<h4 id="网络线程模型"><a href="#网络线程模型" class="headerlink" title="网络线程模型"></a>网络线程模型</h4><p>加强版的 Reactor 网络线程模型</p>
<h4 id="消息批量量处理"><a href="#消息批量量处理" class="headerlink" title="消息批量量处理"></a>消息批量量处理</h4><p>合并小的请求，然后以流的方式进行交互，直顶网络上限。</p>
<h3 id="kafka如何实现延迟队列？"><a href="#kafka如何实现延迟队列？" class="headerlink" title="kafka如何实现延迟队列？"></a>kafka如何实现延迟队列？</h3><p><strong>基于时间轮自定义了一个用于实现延迟功能的定时器（SystemTimer）</strong>。基于时间轮可以将插入和删除操作的时间复杂度都降为<code>O（1）</code>。</p>
<p><strong>底层使用数组实现，</strong>数组中的每个元素可以存放一个TimerTaskList对象。TimerTaskList是一个环形双向链表，在其中的链表项TimerTaskEntry中封装了真正的定时任务TimerTask。</p>
<p><strong>推进时间？</strong>Kafka中的定时器借助了JDK中的DelayQueue来协助推进时间轮。具体做法是对于每个使用到的TimerTaskList都会加入到DelayQueue中。Kafka中的<code>TimingWheel</code>专门用来执行插入和删除TimerTaskEntry的操作，而DelayQueue专门负责时间推进的任务。再试想一下，DelayQueue中的第一个超时任务列表的expiration为200ms，第二个超时任务为840ms，这里获取DelayQueue的队头只需要O（1）的时间复杂度。如果采用每秒定时推进，那么获取到第一个超时的任务列表时执行的200次推进中有199次属于“空推进”，而获取到第二个超时任务时有需要执行639次“空推进”，这样会无故空耗机器的性能资源，<strong>这里采用DelayQueue来辅助以少量空间换时间，从而做到了“精准推进”</strong>。Kafka中的定时器真可谓是“知人善用”，用TimingWheel做最擅长的任务添加和删除操作，而用DelayQueue做最擅长的时间推进工作，相辅相成。</p>
<h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><p><strong>基于消息队列的事务实现。</strong></p>
<ul>
<li>订单系统在消息队列上开启一个事务。</li>
<li>然后订单系统给消息服务器<strong>发送一个“半消息”</strong>，这个半消息不是说消息内容不完整，它包含的内容就是完整的消息内容，半消息和普通消息的唯一区别是，在事务提交之前，<strong>对于消费者来说，这个消息是不可见的</strong></li>
<li>半消息发送成功后，<strong>订单系统就可以执行本地事务</strong>了，在订单库中创建一条订单记录，并提交订单库的数据库事务。然后根据本地事务的执行结果决定提交或者回滚事务消息。</li>
<li>如果订单创建成功，那就<strong>提交事务消息</strong>，购物车系统就可以消费到这条消息继续后续的流程。如果订单创建失败，那就<strong>回滚事务消息</strong>，购物车系统就不会收到这条消息。这样就基本实现了“要么都成功，要么都失败”的一致性要求。</li>
</ul>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《kafka必知必会》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/04/08/interview-kafka/" property="cc:attributionName"
               rel="cc:attributionURL">
                wangyixin-tom
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'ea3985c0f8fdba464dea',
        clientSecret: '2856369f95a20dce67cacde330ad344d409acb09',
        repo: 'wangyixin-tom.github.io',
        owner: 'WangYixin-Tom',
        admin: "WangYixin-Tom",
        id: '2021/04/08/interview-kafka/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/04/10/interview-mysql/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="mysql必知必会">
                        
                        <span class="card-title">mysql必知必会</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            架构server层

连接器：管理连接，权限验证

查询缓存

分析器：词法、语法解析

优化器：生成执行计划，索引选择

执行器：操作引擎，返回结果


存储引擎层

负责数据存储和提取，插件式，支持InnoDB、MyISAM多个存储引擎
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/interview/" class="post-category" target="_blank">
                                    interview
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/interview/" target="_blank">
                        <span class="chip bg-color">interview</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/04/05/interview-rabbitmq/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="rabbitmq必知必会">
                        
                        <span class="card-title">rabbitmq必知必会</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            MQ的优缺点优点
异步 - 不需要立即处理的消息可以之后慢慢处理。异步处理可以提高系统吞吐量。
解耦 - 各个系统间通过消息通信，不用关心其他系统的处理。
削锋 - 可以通过消息队列支撑突发访问压力；可以缓解短时间内的高并发请求，不会因为突
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/interview/" class="post-category" target="_blank">
                                    interview
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/interview/" target="_blank">
                        <span class="chip bg-color">interview</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 好好学习<br />'
            + '作者: wangyixin-tom<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2010-2021 yixin. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">175.3k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/WangYixin-Tom" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:tomwangyx@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/WangYixin-Tom" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>



    <a href="http://wpa.qq.com/msgrd?v=3&uin=2276505170&site=qq&menu=yes" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-qq"></i>
    </a>



    <a href="https://weibo.com/WangYixin-Tom" class="tooltipped" target="_blank" data-tooltip="关注我的微博" data-position="top" data-delay="50">
        <i class="fa fa-weibo"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 80000;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2020, 10, 25, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>
	<!-- 
    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>-->
	

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    

    <!-- 雪花特效 -->
    

</body>

</html>